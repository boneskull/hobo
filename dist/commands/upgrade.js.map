{"version":3,"sources":["../../src/commands/upgrade.js"],"names":[],"mappings":"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","file":"upgrade.js","sourcesContent":["'use strict';\n\nlet Promise = require('bluebird');\nlet which = Promise.promisify(require('which'));\nlet logger = require('./../logger');\nlet execFile = require('child-process-promise').execFile;\nlet semver = require('semver');\nlet _ = require('lodash');\nlet devDeps = require('../../package.json').devDependencies;\nlet utils = require('./../utils');\n\nfunction rangeToVersion(range) {\n  try {\n    const sets = new semver.Range(range, true).set;\n    if (sets.length > 1) {\n      return String(range);\n    }\n    return String(_.first(_.first(sets)).semver);\n  } catch (ignored) {\n    return false;\n  }\n}\n\nfunction upgrade(cwd, log) {\n  log = log || logger;\n  cwd = cwd || process.cwd();\n\n  let parentPkg;\n  let parentDevDeps;\n  let parentName;\n  try {\n    parentPkg = require(`${cwd}/package.json`);\n    parentName = parentPkg.name || `package at ${cwd}`;\n    parentDevDeps = parentPkg.devDependencies || {};\n  } catch (e) {\n    throw new Error(`No package.json found in ${cwd}`);\n  }\n\n  log.info('Installing new/upgraded development dependencies.');\n\n  let successes = 0;\n  let failures = 0;\n\n  return Promise.all([\n    which('npm'),\n    utils.isGit(cwd)\n  ])\n    .spread(function upgradeDeps(npm, isGit) {\n      log.log(`Using npm at ${npm}`);\n      if (isGit) {\n        log.info(`Package is under version control; saving upgrades.`);\n        log.info(`Don't forget to index & commit changes to package.json!`);\n      }\n      return Promise.each(_.keys(devDeps), function upgradeDep(dep) {\n        let ver;\n        let parentVer;\n        let parentMissingDep;\n        if (!_.startsWith(devDeps[dep], 'github:')) {\n          ver = rangeToVersion(devDeps[dep]);\n          parentVer = parentDevDeps[dep] && rangeToVersion(parentDevDeps[dep]);\n          parentMissingDep = !parentVer;\n        } else {\n          parentMissingDep = parentDevDeps[dep] !== devDeps[dep];\n        }\n        if (parentMissingDep || ver && semver.ltr(parentVer, ver)) {\n          ver = devDeps[dep];\n          if (parentMissingDep) {\n            log.info(`Package \"${parentName}\" missing devDep \"${dep}@${ver}\"`);\n          } else {\n            parentVer = parentDevDeps[dep];\n            log.info(`Package \"${parentName}\" has \"${dep}\" ${parentVer} < ` +\n              `${ver}; upgrading`);\n          }\n\n          const args = ['install', `${dep}@${ver}`];\n          if (isGit) {\n            args.push('--save-dev');\n          }\n          return execFile(npm, args, {\n            cwd: cwd\n          })\n            .then(function success() {\n              if (isGit) {\n                log\n                  .info(`Installed devDep \"${dep}@${ver}\" (with \"--save-dev\")`);\n              } else {\n                log.info(`Installed devDep \"${dep}@${ver}\"`);\n              }\n              successes++;\n            })\n            .catch(function fail(err) {\n              log.warn(err);\n              failures++;\n            });\n        }\n      });\n    })\n    .then(function report() {\n      if (successes || failures) {\n        log.ok(`Upgraded ${successes} package(s) with ${failures} ` +\n          `failure(s).`);\n      } else {\n        log.ok(`All packages up-to-date!`);\n      }\n    });\n}\n\nmodule.exports = upgrade;\n"]}